<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ãã‚‰ãã‚‰</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    html,body{min-height:100vh;overscroll-behavior:none;}
    body{
      font-family:'Hiragino Sans','Hiragino Kaku Gothic ProN','Noto Sans JP',sans-serif;
      background:linear-gradient(150deg,#0f0c29 0%,#302b63 55%,#24243e 100%);
      color:white; padding:12px 8px 48px;
    }
    button{font-family:inherit;cursor:pointer;border:none;outline:none;}
    button:active{transform:scale(0.95);}
    ::-webkit-scrollbar{display:none;}

    @keyframes bounce{from{transform:translateY(0) translateX(-50%)}to{transform:translateY(-6px) translateX(-50%)}}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    @keyframes diceSpin{0%{transform:rotate(-10deg)}100%{transform:rotate(10deg)}}
    @keyframes danger{from{opacity:1}to{opacity:0.4}}
    @keyframes glow{0%{text-shadow:0 0 8px #a5f3fc44}100%{text-shadow:0 0 20px #a5f3fc99,0 0 40px #a5f3fc44}}

    #app{max-width:460px;margin:0 auto;}
    .fade{animation:fadeIn 0.3s ease;}

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .header{text-align:center;margin-bottom:14px;}
    .header-sub{font-size:11px;color:#6366f1;letter-spacing:0.25em;font-weight:bold;margin-bottom:2px;}
    .header-title{
      font-size:36px;font-weight:bold;letter-spacing:0.1em;line-height:1.1;
      background:linear-gradient(90deg,#f472b6,#a78bfa,#67e8f9);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
    }
    .header-btns{display:flex;gap:8px;justify-content:center;margin-top:10px;}

    /* ãƒœã‚¿ãƒ³å…±é€š */
    .btn{
      border-radius:11px;font-weight:bold;font-size:13px;
      padding:9px 15px;border:2px solid;line-height:1.3;
      transition:transform 0.1s,opacity 0.2s;color:white;
    }
    .btn:disabled{opacity:0.4;cursor:not-allowed;}
    .btn-green {background:#4ade80;border-color:#16a34a;color:#052e16;}
    .btn-purple{background:#818cf8;border-color:#4338ca;}
    .btn-orange{background:#fb923c;border-color:#c2410c;}
    .btn-gray  {background:#475569;border-color:#334155;}
    .btn-dark  {background:#1e1b4b;border-color:#3730a3;}
    .btn-red   {background:#f87171;border-color:#dc2626;}
    .btn-yellow{background:#facc15;border-color:#a16207;color:#422006;}
    .btn-pink  {background:#f472b6;border-color:#be185d;}
    .btn-lg    {font-size:15px;padding:13px 28px;}

    /* ãƒŸãƒ‹ãƒãƒƒãƒ— */
    .minimap-wrap{
      background:rgba(15,12,41,0.7);border-radius:18px;
      padding:14px;margin-bottom:12px;
      border:1px solid rgba(99,102,241,0.25);
    }
    .minimap-pos{font-size:11px;color:#6366f1;text-align:center;margin-bottom:10px;letter-spacing:0.1em;}
    .minimap-grid{display:flex;flex-direction:column;gap:5px;align-items:center;}
    .minimap-row{display:flex;gap:5px;}
    .minimap-sq{
      width:38px;height:38px;border-radius:9px;border:2px solid;
      display:flex;align-items:center;justify-content:center;
      font-size:13px;position:relative;transition:all 0.3s ease;
      background:#1e1b4b;border-color:#3730a3;color:#4338ca;
    }
    .minimap-sq.rev{font-size:18px;}
    .minimap-sq.active{transform:scale(1.18);z-index:2;}
    .minimap-sq .deer{
      position:absolute;top:-11px;left:50%;
      font-size:14px;animation:bounce 0.5s infinite alternate;
      filter:drop-shadow(0 2px 4px rgba(0,0,0,0.6));
    }

    /* ãƒã‚¹æƒ…å ± */
    .sq-info{border-radius:16px;padding:16px;margin-bottom:12px;border:1px solid;animation:fadeIn 0.35s ease;}
    .sq-info-head{display:flex;align-items:center;gap:12px;margin-bottom:10px;}
    .sq-icon{font-size:34px;line-height:1;}
    .sq-title{font-weight:bold;font-size:16px;margin-bottom:2px;}
    .sq-type{font-size:11px;color:#94a3b8;}
    .sq-desc{font-size:14px;line-height:1.8;color:#e2e8f0;}
    .sq-penalty{margin-top:10px;font-size:12px;color:#f472b6;background:#f472b611;border-radius:8px;padding:8px 12px;border:1px solid #f472b633;}

    /* ã‚µã‚¤ã‚³ãƒ­ */
    .dice-wrap{text-align:center;}
    .dice-label{font-size:13px;color:#818cf8;margin-bottom:6px;}
    .dice-result{font-size:16px;color:#facc15;font-weight:bold;margin-bottom:4px;min-height:24px;}
    .dice-btn{
      font-size:84px;line-height:1;background:none;border:none;
      display:block;margin:0 auto;user-select:none;
      filter:drop-shadow(0 4px 14px rgba(0,0,0,0.45));
      transition:filter 0.2s,opacity 0.2s;
    }
    .dice-btn.rolling{
      filter:drop-shadow(0 0 18px #f472b6) drop-shadow(0 0 36px #f472b688);
      animation:diceSpin 0.3s ease infinite alternate;
    }
    .dice-btn:disabled{opacity:0.35;cursor:not-allowed;}

    /* ã‚¿ã‚¤ãƒãƒ¼ */
    .timer-wrap{
      background:rgba(15,12,41,0.7);border-radius:18px;
      padding:18px;margin-bottom:12px;
      border:1px solid rgba(129,140,248,0.35);
      text-align:center;animation:fadeIn 0.3s ease;
    }
    .timer-display{
      font-family:'Courier New',monospace;font-size:62px;
      font-weight:bold;line-height:1;margin-bottom:6px;
      color:#e0e7ff;transition:color 0.3s;
    }
    .timer-display.running{color:#a5f3fc;animation:glow 1s ease infinite alternate;}
    .timer-display.danger{color:#ff4444 !important;animation:danger 0.4s ease infinite alternate !important;}
    .timer-tags{display:flex;gap:6px;justify-content:center;margin-bottom:12px;flex-wrap:wrap;}
    .timer-tag{border-radius:6px;padding:2px 8px;font-size:11px;border:1px solid;}
    .timer-btns{display:flex;gap:7px;justify-content:center;flex-wrap:wrap;}

    /* ã‚³ãƒ¼ã‚¹é¸æŠ */
    .course-btn{
      border-radius:14px;color:white;font-weight:bold;
      font-size:15px;padding:14px 16px;text-align:left;
      border:2px solid;cursor:pointer;width:100%;
      font-family:'Hiragino Sans','Noto Sans JP',sans-serif;
    }
    .course-btn-sub{font-size:12px;opacity:0.85;margin-top:3px;}

    /* ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ */
    .roulette-wrap{
      background:rgba(15,12,41,0.7);border-radius:18px;
      padding:16px;border:1px solid rgba(244,114,182,0.35);
      text-align:center;animation:fadeIn 0.3s ease;
    }
    .roulette-label{font-size:12px;color:#94a3b8;margin-bottom:8px;}
    .roulette-num{
      font-size:58px;font-weight:bold;font-family:monospace;
      min-height:74px;display:flex;align-items:center;justify-content:center;
      color:#475569;transition:color 0.2s;
    }
    .roulette-num.spinning{color:#f472b6;text-shadow:0 0 24px #f472b688;}
    .roulette-num.done{color:#4ade80;text-shadow:0 0 20px #4ade8088;}
    .roulette-btns{display:flex;gap:8px;justify-content:center;margin-top:10px;}

    /* åˆ¤å®š */
    .judge-wrap{text-align:center;padding:8px 0;animation:fadeIn 0.3s ease;}
    .judge-label{font-size:16px;margin-bottom:16px;color:#e2e8f0;}
    .judge-btns{display:flex;gap:12px;justify-content:center;}

    /* ã‚´ãƒ¼ãƒ« */
    .goal-wrap{
      text-align:center;padding:32px;
      background:linear-gradient(135deg,#34d39922,#4ade8011);
      border-radius:24px;border:2px solid #34d39988;
      animation:fadeIn 0.5s ease;
    }
    .goal-icon{font-size:72px;margin-bottom:8px;}
    .goal-title{font-size:26px;font-weight:bold;color:#34d399;margin-bottom:8px;}
    .goal-sub{color:#94a3b8;margin-bottom:24px;}

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-bg{
      position:fixed;inset:0;background:rgba(0,0,0,0.8);
      backdrop-filter:blur(6px);display:flex;
      align-items:center;justify-content:center;
      z-index:1000;animation:fadeIn 0.2s ease;
    }
    .modal-box{
      background:#1e1b4b;border:1px solid rgba(129,140,248,0.5);
      border-radius:22px;padding:26px 22px;
      max-width:340px;width:90%;
      box-shadow:0 30px 70px rgba(0,0,0,0.65);
    }
    .modal-title{font-weight:bold;font-size:18px;margin-bottom:14px;text-align:center;}
    .modal-msg{color:#94a3b8;margin-bottom:16px;font-size:14px;text-align:center;}
    .modal-msg.warn{color:#f472b6;}
    .modal-btns{display:flex;gap:8px;justify-content:center;}
  </style>
</head>
<body>
<div id="app">
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="header">
    <div class="header-sub">TICKLING SUGOROKU</div>
    <div class="header-title">ãã‚‰ãã‚‰</div>
    <div class="header-btns">
      <button id="audioBtn" class="btn btn-green btn-lg" style="font-size:18px;padding:14px 40px;">ğŸ® ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    </div>
  </div>

  <!-- ãƒŸãƒ‹ãƒãƒƒãƒ— -->
  <div class="minimap-wrap">
    <div class="minimap-pos" id="posLabel">ç¾åœ¨ä½ç½®ï¼šãƒã‚¹0</div>
    <div class="minimap-grid" id="minimap"></div>
  </div>

  <!-- ãƒã‚¹æƒ…å ± -->
  <div class="sq-info" id="sqInfo">
    <div class="sq-info-head">
      <span class="sq-icon" id="sqIcon">ğŸ¦Œ</span>
      <div>
        <div class="sq-title" id="sqTitle">ã‚¹ã‚¿ãƒ¼ãƒˆ</div>
        <div class="sq-type" id="sqType">ã‚¹ã‚¿ãƒ¼ãƒˆ</div>
      </div>
    </div>
    <div class="sq-desc" id="sqDesc">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆï¼ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã£ã¦ã­</div>
    <div class="sq-penalty" id="sqPenalty" style="display:none"></div>
  </div>

  <!-- ãƒ•ã‚§ãƒ¼ã‚ºUIï¼ˆå„ãƒ•ã‚§ãƒ¼ã‚ºã§show/hideï¼‰ -->

  <!-- ã‚µã‚¤ã‚³ãƒ­ / 1ãƒã‚¹é€²ã‚€ãƒœã‚¿ãƒ³ -->
  <div id="phaseRoll" class="dice-wrap fade">
    <!-- é€šå¸¸ï¼šã‚µã‚¤ã‚³ãƒ­ -->
    <div id="diceArea">
      <div class="dice-label">ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã£ã¦ãã ã•ã„</div>
      <div class="dice-result" id="diceResult"></div>
      <button class="dice-btn" id="diceBtn">âš„</button>
    </div>
    <!-- ã‚³ãƒ¼ã‚¹å¾Œï¼š1ãƒã‚¹é€²ã‚€ -->
    <div id="advanceArea" style="display:none;text-align:center;padding:16px 0;">
      <button class="btn btn-purple" id="advanceBtn" style="font-size:18px;padding:16px 32px;">â–¶ 1ãƒã‚¹é€²ã‚€</button>
    </div>
  </div>

  <!-- ãƒã‚¹ç¢ºèª(éè¡¨ç¤ºåŒ–) -->
  <div id="phaseSquare" style="display:none;text-align:center;" class="fade">
    <div style="font-size:14px;color:#94a3b8;margin-bottom:12px;" id="squareMsg"></div>
    <button class="btn btn-purple btn-lg" id="squareConfirmBtn">ãƒã‚¹ã®å†…å®¹ã‚’ç¢ºèª â†’</button>
  </div>

  <!-- ã‚¿ã‚¤ãƒãƒ¼ -->
  <div id="phaseTimer" class="timer-wrap" style="display:none;">
    <div class="timer-display" id="timerDisp">00:00</div>
    <div class="timer-tags" id="timerTags"></div>
    <div class="timer-btns">
      <button class="btn btn-green" id="timerStartBtn">â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      <button class="btn btn-gray"  id="timerResetBtn">â†º ãƒªã‚»ãƒƒãƒˆ</button>
      <button class="btn btn-purple" id="timerAdd20Btn">+20ç§’</button>
      <button class="btn btn-yellow" id="timerDoubleBtn" style="display:none;">ğŸ« 2å€</button>
      <button class="btn btn-dark"   id="timerSkipBtn">ã‚¹ã‚­ãƒƒãƒ—</button>
    </div>
  </div>

  <!-- åˆ¤å®š -->
  <div id="phaseJudge" class="judge-wrap" style="display:none;">
    <div class="judge-label" id="judgeQuestion">åˆ¤å®šã—ã¦ãã ã•ã„</div>
    <div class="judge-btns">
      <button class="btn btn-green btn-lg" id="judgeClearBtn">â­• ã‚»ãƒ¼ãƒ•</button>
      <button class="btn btn-red   btn-lg" id="judgeFailBtn">âœ• ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </div>

  <!-- ã‚³ãƒ¼ã‚¹é¸æŠ -->
  <div id="phaseCourse" style="display:none;" class="fade">
    <div style="font-size:15px;text-align:center;margin-bottom:12px;color:#e2e8f0;">ã‚³ãƒ¼ã‚¹ã‚’é¸ã‚“ã§ãã ã•ã„</div>
    <div style="display:flex;flex-direction:column;gap:8px;">
      <button class="course-btn" id="courseSweetBtn"   style="background:#f472b6;border-color:#be185d;">
        <div>ğŸ’• ç”˜ã€…ã‚³ãƒ¼ã‚¹</div><div class="course-btn-sub">ã‚„ã•ã—ã„ãã™ãã‚Š</div>
      </button>
      <button class="course-btn" id="courseTortureBtn" style="background:#818cf8;border-color:#4338ca;">
        <div>â›“ï¸ æ‹·å•ã‚³ãƒ¼ã‚¹</div><div class="course-btn-sub">æœ¬æ ¼çš„ãªãã™ãã‚Šæ‹·å•</div>
      </button>
      <button class="course-btn" id="courseManiacBtn"  style="background:#fb923c;border-color:#c2410c;">
        <div>ğŸ”¥ ãƒãƒ‹ã‚¢ãƒƒã‚¯ã‚³ãƒ¼ã‚¹</div><div class="course-btn-sub">ç‰¹æ®Šå™¨å…·ã‚‚ä½¿ã†ä¸Šç´šè€…å‘ã‘</div>
      </button>
      <button class="course-btn" id="courseRandomBtn"  style="background:#34d399;border-color:#059669;color:#022c22;">
        <div>ğŸ² ãƒ©ãƒ³ãƒ€ãƒ </div><div class="course-btn-sub">ã‚³ãƒ¼ã‚¹ã‚’ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã§æ±ºå®šï¼</div>
      </button>
    </div>
  </div>

  <!-- ã‚¿ã‚¤ãƒ ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆï¼ˆã‚³ãƒ¼ã‚¹å¾Œï¼‰ -->
  <div id="phaseRoulette" style="display:none;background:rgba(15,12,41,0.7);border-radius:18px;padding:16px;border:1px solid rgba(244,114,182,0.35);" class="fade">
    <div style="font-size:12px;color:#94a3b8;margin-bottom:8px;text-align:center;">ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã§æ–½è¡“æ™‚é–“ã‚’æ±ºå®šï¼</div>
    <div id="rouletteNum" style="font-size:58px;font-weight:bold;font-family:monospace;min-height:74px;display:flex;align-items:center;justify-content:center;color:#475569;transition:color 0.2s;">---</div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:10px;">
      <button class="btn btn-pink" id="rouletteSpinBtn">ğŸ° ã‚¹ãƒ”ãƒ³ï¼</button>
      <button class="btn btn-green" id="rouletteApplyBtn" style="display:none;">âœ“ æ±ºå®š</button>
    </div>
    <div style="font-size:11px;color:#6366f1;margin-top:8px;text-align:center;">ç¢ºå®šå¾Œã€è‡ªå‹•ã§ã‚¿ã‚¤ãƒãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
  </div>

  <!-- ã‚´ãƒ¼ãƒ« -->
  <div id="phaseGoal" class="goal-wrap" style="display:none;">
    <div class="goal-icon">ğŸ†</div>
    <div class="goal-title">ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ï¼</div>
    <div class="goal-sub">ã”è¤’ç¾ï¼Ÿç½°ã‚²ãƒ¼ãƒ ï¼Ÿæ¥½ã—ã‚“ã§ã­â™ª</div>
    <button class="btn btn-green btn-lg" id="goalReplayBtn">ã‚‚ã†ä¸€åº¦éŠã¶</button>
  </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ç¾¤ -->
<div class="modal-bg" id="modalSkip"  style="display:none;">
  <div class="modal-box">
    <div class="modal-title">ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼Ÿ</div>
    <div class="modal-msg">ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚ºã«é€²ã¿ã¾ã™ã€‚</div>
    <div class="modal-btns">
      <button class="btn btn-red"  id="skipYes">ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹</button>
      <button class="btn btn-dark" id="skipNo">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>



<script>
// ============================================================
// ãƒ‡ãƒ¼ã‚¿
// ============================================================
const DEER_B64="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAYAAACOEfKtAAABdmlDQ1BJQ0MgUHJvZmlsZQAAeJylkLFLw0AYxV9bRdFKBx0cHDIUB2lB6uKodShIKaVWsOqSpEkrJG1IUkQcHVw7dFFxsYr/gW7iPyAIgjq56OygIIKU+K4pxKGd/MLd9+PdvcvdA8JNQzWdoXnArLl2IZOWNkqbEv6UrDrWcj6fxcD6ekRI9IekOGvwvr41XtYcFQiNkhdVy3bJS+TcrmsJbpKn1KpcJp+TEzYvSL4XuuLzm+CKz9+C7WJhBQhHyVLF54RgxWfxFkmt2ibZIMdNo6H27iNeEtVq62vsM93hoIAM0pCgoIEdGHCRZK8xs/6+VNeXQ50elbOFPdh0VFClN0G1wVM1dp26xs/gDlaQfZCpoy+k/D9EV4HhV8/7nANGToDOoef9nHlepw1EnoHbVuCvtxjnO/VmoMVPgdgBcHUTaMoFcM2Mp18s2Za7UoQjrOvAxyUwUQImmfXY1n/X/bx762g/AcV9IHsHHB0Ds9wf2/4F9IxzaxM+sS0AAB5ZSURBVHja7VxndFzVtf72uWWaerdsy7ItN8kN24AxdmQndHBiAqPwIAkQAoTihBYgFI+UYEIJCdUkJgSSECfI4dF7kwAXTDEukntRs3qZoin33nP2+zGyQxIIGBvb5HmvNWuWtEZ3zv3OPrt8+7sCDtthO2yH7bAdtsN22L6SRvvzYtXVfq3ugQ7CbKCyskYSEe+v61VV1UoAfHjLDqENP5QWRLpu8B/u//ncrVs3npaTl982/6e33wmgHwC+gCcSQHz/7ded09PZ9bXcQYWrfnRV1R+IiBkgOoQ8UezrBQKBgNA0nW+7ef7iD999+5mO7esu2rVt7YI/LLr9O0TElZWV2t5cjwMBAYBfeeXJads31T3Wuf2jizavXv77ymsueJGZXZWBADEfOp64TwD6/X6tqqpKPXB75UXN29Zc2NfVZMuEk7DjChpEU3l5ub6331EJiPLycj3D4+tx63oslojbkVBPoqNpw4m3Lbjs3srKSlRWHjoAfuGFEBGYmZjZFfjJ2Ztbd9YPFiSk4fYYwyces/jqG++6eF8X96dFt12yZsWri8LBTmlLIK+oRLvgwmvLRk+ZXs+BgKCqKvWV9UClFggAvLzm2eJwb1cBKWKGMny5BRuurbzn4rdee2HiXVVXPPLQrxfczMwGM9NnhQIiwpKH7j733l9c+/DTjy067fuXXv9gxqCiJ0zDqxlCyFioE6+99XLZbk89FDxQ35tYB0CUlZWx3+9XS5dWEABs3bQtE0QGM1tuj1fzebIe2bxxU/6jv7n5je7WzdlGaja2rP9gyegJ07YxM31SQhn4vWJm74Krz7+3a+v6tN72oT/4+98Wn+QEYw+EdjWckYhHlWBwpC+c8/G/W7p0qVi6dClKS0u56iB45OcFkAYWpz4GqAZAFuTnWQApEOmx/jh8Kca5Tzx85yUt29Zne70uZOUMqsGg4s6LLppqAHA+JRxwwO83a2pqrNz8/L90N265pGHbRhmJy8dGlZVu7IsGIYTQCEQej9sGgJ6eHo2IHAByz5oAUfWxNR4yMZCEwIsvPDW2t3XrkQW5Qzpnn+qvJaIYAGLmzBsu9W/taNmWKUhnUzdISglWEoOGjd1w0Y9+dnJhWVnD544pmo7bb770rR11K2ZZtg3D5YadsEG2w96cAjrFf8G0E0+rWA1AMbO2atkLR7z7zipxqt/fNnLk+MZDJokQERYsWCAqKyu1h+/+5S3r1755VYqpdMfWIIyM7UccOevOsy6+6rdghdtvuOTBLRve+xEc5TALAShOycoLHfm1Uyaddf6lu+66+eobUnLSRhw/87QrRkydGvp4bTgQG8XtlVdd4vG6x8w6/pv3HnHE9IZrL6/4sLdl5zjAUTpp5CgphoybVh/45eIpRGRVL/n9qeveW35LNNgy2XEsGGZadPjYaVWXXn3TbyoqKtTSpUvlgQBQ+/Q2qlq7/PLL1ZxjJpSvevu5xWOHuOiEWePl0NxUJCKdWevWrTlt7rdOKnvlzXef9Xq9axobdswPdnUITdely+PS84cM++Ull92w9ufXXvRW89bV3wn17posXd7YxCnTawHotbW1qtrv18ZXVKjJZWXjN6yuebZl2+qjGnZuPtdRkRUjRk9Y07K9/gwnGpZKOsgoKNImTi0/f9KUozcuvqfy7g9qnru3wB0pOPaIYj5qcjGraNDcsn3b8aFwZEPlLXesDQQCem1trTpoAJZ2dGi1DQ2qpDjzWtNum3raN46SkAkjNdVDo0cNVikew9lQt3HC8hVvzTzr/CsWbd62ua0/2DW3vz8spUpomiGGr3indn7btrpiy4ogv6gkfMTRM65/+NHH22fXzEZlTQ3K6uqA2bPJf8JZsTVr354d6msfGuxsd7W3dp3d0bB9THfrrnywLs3UFGPYqIl/vOgnC+5c9OsbHq1//82LjyrLk3NmTkVmmlsYRDRuRLGzq2U7bdzRUvzumm0PvfnGGzgQvfN/ioHEzHTDj896d1S2NW32MaUyHOzVhKaDSYfH40VLe5/1/JvvmxlDJr5w48KHTr37l9cubqhbeWFfqNsWptsgywIJrxw6onTnnLlnnjdrzinv+AFtaTLQ88dLqeb6+sw//3XRMw2b3zsmEemHy+Uix7IczeXTh46Z+G7lnY9Ov+/WG362ZW3NrcdOHmRPKR2uR2NxYpaQkuHxerGjqYNfXNHonPXDBZOnf+1r9RxgQVX0pXrhJ9ZSA3GJAXiikUheRqoHltQoc3ApzPRC2Eoh3h9FUX6GecL08XZX47pT7rn9uuuuvOHOi4aMOuJxjzfbgK0kJJxBQ0vkzXc9/K1Zc055xzBdeEIzJCCYmd3MnKnphiKhqSGlpd3X//y+bwwZMWab0HVWDtmG160XjZ647sab7/jukkcfmLpl/bJbJ5VkOpMnjtJjsQjZSsH0ZSOnqBQ2BAry0mW6h4wVy58vT9aKleKgljHBYNClpEx3e0yQy6TCkqkgAO3Nm9DZuAHRSAijhw/WWzu65HtrPwi88ewTL8857fSzFl53UXtr08ZLrVicdrVsNgJXnr345ivPrY+Gw6Ni8agnEgnyj889pcDjTUm95KxvbLel0+lLTW1eeN1Fgxp2bh2ug1jzevS8YSNfOvnked+HO733/eWvrctJsXjWURMoHAoSazqyCsdhUNE46KaJaLADBmJIS3Ej1BuaAACoqTm4dWBjYyMrx5YaCQhScBwHuuHCoOJSpKTmoHHLCkSivXT01DJsaVrmWb7y1d95fb6jb7jtd7/8TdVlZ76/8u1BqW4NKtg0oyA/e0ZKuoFUXy50owCOlFBKQVBeVjSeQDgaR2f3Jhh2FOFIXJUUj46ec+H1t5SMKuu8/85AQAZ3jZ1zwlQnlujXoaWgaPQUZOYXQzoK7DiAAJgAt9uDjr5+/UCVMf/xiyZMmACX7hYJxwE7NmBZIMMNtmykZg3CyAlz0FC/Emz3ajOmlfALtR8ddd8d16+47Punjk2jUMZxM8by8GGDKCfTq9w6KSEEDYSIZIwFkSClAAIYnHAU9fZZ2o6mLrFxyw7v7T+7+OU/3BNYtvaDd2dOGpHPuVkpWkwQSsbOgDctH45tQ4OAVAk4iQQMMmBZFgvhsQ8qgAM1GgEIC8No6O2LpDuOpXq627VBablgx4GSUbg9GRheNgPbN9ZgeKGLxgxp5fdfr55+9JQxmDR2LFJTXORIG7YdF/GEJnh3Xvyn1KU0MAFEEJDISjeQk1OEKWWDacPmXb6VK547IUUnTJk4EzYERpbNgseXAelEQRAg3USotQOWFYNNjGA4Tln5o+oAALNnA7W1B4dMCJSXa0Tk5BUOq9nR2EsyIbmvdT36e3eBXG4IdkHZNnTTi+Jxx4FNH449upQu8J8gjz1iLJumQDSagG0BBB1EBEEEIQbe97w0CCEgiADS4SiGFYtCcQKTxhez/5sz5dyTj2bT50PR+HK4U7KhEgyNXdB0D+KRbrTsXI1Un4fXb2qhjqDTP2fuuc/t3p2Dx8bMnq0A4LjTT38gpNKdN99eL1wuTe7a/C46mjbAsfshTA0sdLg92fCkpEAXFnwpmpZIxIkVQQgBor2vq0gIEBPisQil+6D5vBpprhR4felQYAiDIDmBrtZtaKhbBo8puG5Lq726rl0rHjX+rmnTxjdWD3CVB62Qrq2tZeaAKCw8v/vKa65or9+045uNO3aI/Fy3o+xujgU7KREPEshGpKcZnY3bIYSCYgkiMbA3X7yOJSQ9VAIg1mDFwiBikAR62jehp20Lh3saVDQYVstXbdLeq2vXhpce9eQVN//qMgB02QOLuKrqECATAoGAqKqqUk898eiZK1599laOd4waUpiKYTlZyMvNgDfVDTCgHQCOmCWBhI5YPIbOzh40d4TQ2NaLOKW3T5r+9bt/cMm1t9mWtXslB2Ru8rlu2+/3a0uXLpXMnPbQooXzdm7b+j+x3p6ZKtruO/qI4ZgyYTg5VhxM2pfGtSvFMA03mlra8ULNWmZXrkWmb9nwUSOr5//01qeIqD3ZPQFEB27o9Lnvt7q6WquoqJC7KafOXQ3HVl3zvVeOmZDnOXJCCeKxGLGgLw1AZobL9KCpuVU+8/Ym7Ztnz7/gpG997w+2bf3TJh+ylH5FRYVkZpo/f75LSUcsXnyvyzAdb0lRNiesBOFLBG83vWbZcRQOzuH8bB9eeuaZbNu2KHDuue4BZvqAg7fXMxEi4qystRKAivZ2TcvxmUjxeJRSB+bEKMUwdQ0FmakI9/YcAyKuj0btfVVAHJCZyB4baC/tRKIkPc0HwzTgxC0cENEAAVAsMrwuGK7+8ayUi4gSX8mpXFtHC5suE4QDF7EJgGRFXp8BwU5eUzDo+xh79NUC0ErEIDRxgDUWlEwmXg8SVkz+ZckS3stceOgASALYLVQ5kCgyM3RNA4MoGAwebPz2HsDdDJsuPMzqQMduHvBCACyRjvQDWDLvJwBnD7zn5g4yLMsGM+91v7uv5YzjOAAB6UXpONj2xY+wobdaMQus1B4vUKyglNrvR1YplfQ6ACQIsYQFjzcdl5x9Nh1sF9x7AAdc0HSbDTHbhm0n50NCI3jcHng8HhD2XcFHTCAmuF0mvB4fdB1gliDSEY7EoGtmHIAFAEKI/YZgIBAQfr9fA0ADcpb9XQfOBlCLESNGtW7/cCcikbhIzUxBbzCGDVu2Q9d1TBpTDLcJ2MrBF+1PmBQAEx/Vt6C3L4zRIwqRn5MKsKS+YFT190dz33rxyRkAXn1jwQJtdmWlRGUlLa2vp6Wf2M8DdXWlXFlZyZ9WeO8mTna3q1VVVbz/AZwNhVogd8jwtWuXyXjYstxmXOHpZ1eitbcPrASaGlsx79QZXzg5MjMMw8Dry9Zj+eqt0EjD6rodOPPUcowYmoFQuF9Z/b36e6ve+h6AV+ZUVTlIclefesNLB1CtGuC4AuXletlll7Hf71dExLt7/Q0bVhcveei+qnBf19jSiUcvvuiKGx/+OLD7DODAhWjuXH/rS0sWNwTDiTGhvha1qzsiUtJTAalhe1Mfmls6MaIoFwnLBu1FlmEGdE2gLxTH+k1NcHu8MIWO/kgcdVu2oqBgCvr6Itrwomy0N+08jZkzAcjnn39HE7JtaMeuVvfmzWsQCoVg2zZgAOmebEybNh3Z+UOCXz/ppA6P19dbVVvr7Kb7AwG/WVFRYdWveXv6I/ctfCpF9uSXZLuwcd1745j5CSLq+zRl2ReaXlX7/YKI7PnfP31FV1d4TFqqS7EQwuEBah4Klp3YK+D+JdVCSgnFDMEGiCWUZkApRmd3L/pjNp14wlg8+fy7GRf7j1/p9bkzLTuie0wj09AElJOAd3d96AAcDuL92kbELCmff/ze0E/Om7sjIzvvnclTp79w0ryzXycia+37a8c+8kDl0z7uzDvj1Jl2PBalLc+v9f3u/vtLALy/tKJC4GNKsH0CsK60lABgxOiy2tam984bXlRAPjcjFk1m5dwMLwoLCpIesJcHmQiQjkR6egqGDsrE5i1dkG4D7EQxruRI7NzRiYz0FAzOz8IJM0sRCVujfSlemG4NurBh6hq7dQ9I05LDPk6GBNuxYSeUFo7EMtu7Q5ltPdumvPbs5h+/VfP86j//8ddPPvrbm65KlX0ZZ37rKGVojhEXGusm4cN339UAYOl+i4EDxAgA+M879/U7r18ZjVtR7xmnHcvLVtaTy2Vg+tQSpHg12Lb8Fy/kPY0DfwY1qZONE742BamuDegKh1E2ehyKh+ThteWrMX7sMAgngZKhOdBcurJskDC9cHtSSDoORcLdEKwgBmZKUkm4XSb0VJ0HD8rA2NGF7EihGtu6xbq6nUe8/ezfjijI8ODMebMYTkI4moDlJNhOsCidPEnhscf2nVD9pBJICE1de/lZr+YZ3d8446QZKhqLaqQJgCUcy4EggiKBf3DsThK6gd4/2VcQiMQ/snWyzYCCgtA0aJoBKRlulwc7m5rxvy+uxFnfnoOsVBfgSDjKgZmRi5IJsyH0VJAGBDsb0LhuGXSScEjAnZoBry8TUtqIdLdBOTEQCRiGAaHravl7m9SqjzZq3547h0YMSmPbUvazry432xLZbXf89u+jiSiSbBj+PQaKfamXlJIYXTbtr+09ktra2gFyYCUSsG0HJGhgXu7AkXEoJw4wgcgAmV5ophe66YXQTShWcBwLjrSS5QsBRAJSMiwrAcdOwFYW6je1ID8rE7lZmZAy2YgLYUIlHPS2NiLW04r+zmaEu5ohKFmA+9IHY9TkUzB49CwUTZyDoWOmJrdNCFi2g1g8Jo49pkwvHjyE3njzI3xU30hLnlludsTzrGNPmHsxEYUDgQB9WunzhT0wuSEAM3t+cu636icV60XlM8ZyNBoXmqZBSYZSgHD54EnPQlpqLsyUNLjcXmiUvAEAkJYD24kjGg0h3NeOWLAHKhGFphFIAIoZOgT6pYVH/1KDE2dPw5iSbCTiCiSSqmNmQEkGGQQlFQQDQmiAZJDbi8yCYfB40mErG+GuFkT72ve0hWDAEAY6IjYvWfo6XGn5rVkFRc99/eSzH5w5Z85H/6mE2ZcYCCJwoLxcJ6Lowp/Nv31b8/pFE/uiMsWtC9tyoKWkIzdvJDJzB8N0+wAyAGZIpSAGPIAVQ3MpuLwZSMkYhLxBJUhEQ+jp2Imu9gYgEQEJwHB78cHyzTBNEyOL82BZ8YENIAAaiADDEMljT4AkQLi9EELAjsfRsWMtSDOS7aZjQzdd0FweqIQDRznQ4CDDQ7JwSJ6eOfyYn19+deXvFtzxED4LvH0mgpiZKomokjnlivNOWz0iVww/+cTJ7E4dLPKHToTpMpJ3o1SyDdM0wOMB4jaUZUEYBuAxgHgCynEgSACaBhaMeLQXzdvrYPW2oD+h8NDfXsE5FRUYkmkjHu9Pxk0iQMlk2CSGEDpsRSgYNRk5eSPBSoNjh9G4YRWs/nYQuZCSnoOckkkg3Q3hKLQ3rUewbQdchu489cY6vb7ZujiK9IdLS6FVVS21vjQyYfeMpKy6mogoNP34b968uTVC7RGXHDr5axDwQtkKYAcMBTJNRKw4nqx+HLctXIjKqiosvOUWVD/2GEL9EQjTBCddBMoGPGYORpYdhcLR0/DUi+9g9LiJmH3yaZAwBxgggpQ2IEy4PDmA8EAqBwQFWAk4iTikE4Md74eSSa2RlDaIFAxB0IWArmkwNQNQMunRA4P85ICq43OxIvssA/vOd74jq6urNb/f/7+tzVufeOLpmjOGFo23ho0qMe1wECRcgNAQTVi4/9f34KPVH8Hn9e1p2erq1qNuXR2uuu5apHm9gJQQSsIhQE/PxsvVT6O3X+GaH1wAQMCTmYdEtA/sSKTnFGHQyKkQpIMF0NGwBp27NqF9x3p0Nm2B0ADHskBQICGg6UBvdwtCoS4YLi+chAXHcqDrBFtZYAkMLRyq/YM1+Wxh0j4rOJkZA/1k4srr7jh38NAxyxfdf6+5Yd0a28jISwqydB2bN25E3bo65GbnwjRNmKYJl8uF7MxsbN2yDRvq6sGmC7bjgDwmdJ8LSx76PV564UVc9dPrkJWdDbYTSM3IBkiDgIIDQHKSpVGORMJJlkaaLgC2Ie0EhMCehMUM6LoBSAdWfx+UjEHTCEwaYglJ/dEECgcP7vpyp3KfcpSZWRBRPzPPu7PysocXP/jHubPLt+PkU45zTJ9bDB8xQmRkZiIWjcIwjD3HMB6PwefzomjYMAhDh0hLQ0tTI/788J/Q3NiAm2+6GSPHlEFGQtBMDT5vDoQhIBwToe42RHtegK7rkFJCShuGboIUD6iU6BM3HEQg0gEwmB2YukBLe1QLxix71uSJHwFAJaA+j7Rmv3LJu7OW6XLjgZ9fe+WaNR/clJ+lZ02aMglTph/Dm9fXqb8+9hcW0AiUpLIdx8H/nHMOZswup63r12mrPvwQK1a8hZFFg3HZ/GuQlpsPKxKCqRvJGwawZd0bcEJdUIYOUnLPZuzucIgFQDzw6c84QYrh9brVyzVrqTnua174m79OJqLeTyucv1QAd2fmgfaNe3p6in7/68DFbc1bzwLkiILsbPR0d6A73APTMCClRFZqOoqGDUdLawc6e7qRiPbCP3c2Rg3NhDdnOPKLJ4IUJ7VeDJBhoHHjOwi2bYFmeAbUrknoBNTADSWnhYx/eCEzf6I3unRCMKScpa98qI864uvXXHjFgrsCgXK9qqrWwYH2wH/yxvJyvao2uQhm9j799z+Vrv1g5ZSMjNQjg70dGe3tnT2SFA/KKoBUsjlnyLC6woJBrvdef+qvFcdP4hSvTf0JRuHo6cgbUgrYsaR3GSbat69FR8NqaKb5T8AIMJQiSCUhOCmPc9hKJhDN+Hd/JIbQTPXM8++LiMhr/MX9j42vrKT+ykrmz6t2+NLE2FW1tU4gEBCoqRFEFAXw/sBr8af9TTAYzK556YlIa3d3ypj0HDakTe0N65GWngmXNxtKOdAY0E33v+U/AmApguHOQv6QYTANNwgCSiYQ6m5DuKdpgGobmC+DoQmTX3lzNbX365FT/fO+S0Thar9fI/r8z5Z8qWr23U94JsU/FaKuroNQA1TV1nJ5eTntGbHMTg5a0tLSIqbpaw2Go6NIGMykiO0wOprXo2j8HChbg2AJ0nUoaDCY9xB0zAzSDBSPOhLejHRAcRJkImQVlKBh4zKE2rdB17yQCtBchM7OEG9tCsnpJ53zw+Pm+t8OBAJ6RVWVc8Cz8OfJ0v9KRtYOsMG1yR/g9/s1IbTElReevjbSb48iJsVgoekmgj0d2NWwGZm5w6SRmsZpGRmabghSA3QVEcF2bAwuLoO3aBgQjycDoBASkhlKwePL1fvQsGcZutC4qzcsXCmZoXPOv/SFLQ0dorKyUlbtpaz1gD1P8VlWWtpBzAqu1LSG/mg7pHQGODOCFbdw9533se5L14YMGQK3xhg3zERGegqUo0BJkT9WrVqPyDvbYCWiyXbQSmh2XKIvHEU82Ia5x0+Ay1DJHpwM1dkd1dy+rJ0AElVVVfx5hkj7vZDe35biSV3dF7YQSzgkiJK1YswGkRtjxx97T1OnddOyD+pDjc3dLAydmSVModDaE8XSZ59D4+Z30bRtDS+reRMtnZHXo+R+EGb6L7rCUScaS0BpBgQAZTN3BSPwpWe+DcD2+/1fCItDBsCysmTXUjpuwoawxegL9QttoINISJsdXbOOOaniV7fd98eFKWlZG0A6CUEKzNB1Ew2NXSgeMhjnVMzCcbPHI6dgKM7+7lXX/DRw76U33Hr/L0zT15+I2wCYNV1DV19E9EUk8gqKniYiLi3toK80gH5/tQKAeWf/cJsks7Orp5eEJphAbNsOxW0VXb9+fezNN1k3fS49bscHxgUEKQWam7swtLAQdtRGKBRHwk7IlpZ6rby8XO8FvA7sHsuyIDRmTdO4eVeXiMVFxwWXXf0ekPxXVV9pAAcSjRCa3uf2+D5s7w5DJ00KwYhEE3CZnvjpp58u58wRTjQU3ZBIMNhRrOuE9t4weiIRjBiWC8XMtpRkS4qWHTmppba21snRjSDY6OzvT8BkjaFINncG4ctIf5mECA3wmvyVBjDZCpYLVhKDhxXX7OqKoa8/QYZuqGjcgVTcaJhmH8BIy8iOJRIOlGQYpoHtjS0goamsjBQ4ykYoHIPp8kbz8sr6B7hf+FJzWoORGAyhcXtvROzYFZLjxh/5OCtFZXl5X1gacoglkeTTUdNnznuyOyasXa0dQhdu7gsnYLrM7UomT1lhwZCeeMyGlBIJCWxr6kQo4ogNG7bL9Mx0J9gXVQxtrabpYb+/1JBSgkis6gklWDc9sn7jTrAre8d5l17zGgBU7INA/ZACsKqqSvn9fu2oWbM26ab3hS3b21gKtruDQU7JyqjbrfyylVPTE44DIGrd1YOusFKzTpy37v21TdpLr71nNHeGReHgYc8rJTFz5jcIAEaPn7A6FHPo7ZVreEdbvygdP+1XRJQYGJjjv8QDAb/fDzDj66f4f9+bcInHn37d028bNHHKjFd3f+bkuf7tcXZxS1u3XLehiX2ZRSt/OD9wclbx1Aff32r3mjklK64M3PUIM1PPj7NsZtAPLrluhZk1dMfK+i53emHpSz+66qaHAoGAqKiuVvhvs0AgIDRdxyP3Lrzt6h/O6/zN7dc/w8x6IBAQgUBAMLNRefUPVlx7fjlff+k8fmLJIyd9jGHJ/FfR+W6Z2qpVr4957unHvs3Mrt3MEf7bjZlzTNO1J1nvBuOZv/9l7C9uvOR3i+658XsgQnV1tRYI/NOJon8dw+L/mwU+f4ihj/ORn0bTBQIBUV1dre1Pz6OvgAfuIWj//VjWiLL6PK44SI95HbbDdtgO2/93+z8XM9nIIrronwAAAABJRU5ErkJggg==";
const BASE_SQUARES = [
  {id:0,  type:"start",   title:"ã‚¹ã‚¿ãƒ¼ãƒˆ",   icon:"ğŸ", timer:null, judge:null,              fail:null},
  {id:1,  type:"missionA",title:"ãƒã‚¹1",      icon:"âœ…", timer:1,    judge:"å£°ã‚’å‡ºã—ãŸï¼Ÿ",    fail:"restart"},
  {id:2,  type:"missionA",title:"ãƒã‚¹2",      icon:"âœ…", timer:1,    judge:"æ‰‹ã‚’ä¸‹ã—ãŸï¼Ÿ",    fail:"restart"},
  {id:3,  type:"missionA",title:"ãƒã‚¹3",      icon:"âœ…", timer:null, judge:"å£°ã‚’å‡ºã—ãŸï¼Ÿ",    fail:"penalty:30"},
  {id:4,  type:"missionA",title:"ãƒã‚¹4",      icon:"âœ…", timer:1,    judge:"å››ã¤ã‚“é€™ã„å´©ã‚ŒãŸï¼Ÿ", fail:"retry"},
  {id:5,  type:"debuff1", title:"ãƒ‡ãƒãƒ•",     icon:"âš¡", timer:null, judge:null,              fail:null},
  {id:6,  type:"missionB",title:"ãƒã‚¹6",      icon:"â­•", timer:1,    judge:null,              fail:null},
  {id:7,  type:"missionB",title:"ãƒã‚¹7",      icon:"â­•", timer:1,    judge:null,              fail:null},
  {id:8,  type:"missionA",title:"ãƒã‚¹8",      icon:"âœ…", timer:1,    judge:"è¶³ã‚’é–‰ã˜ãŸï¼Ÿ",    fail:"back:3"},
  {id:9,  type:"missionA",title:"ãƒã‚¹9",      icon:"âœ…", timer:2,    judge:"æ‰‹ã‚’ä¸‹ã—ãŸï¼Ÿ",    fail:"back:2"},
  {id:10, type:"missionB",title:"ãƒã‚¹10",     icon:"â­•", timer:2,    judge:null,              fail:null},
  {id:11, type:"missionB",title:"ãƒã‚¹11",     icon:"âœ…", timer:2,    judge:null,              fail:null},
  {id:12, type:"missionA",title:"ãƒã‚¹12",     icon:"âœ…", timer:2,    judge:"å´©ã‚Œè½ã¡ãŸï¼Ÿ",    fail:"retry"},
  {id:13, type:"missionA",title:"ãƒã‚¹13",     icon:"âœ…", timer:2,    judge:"å´©ã‚Œè½ã¡ãŸï¼Ÿ",    fail:"back:4"},
  {id:14, type:"debuff2", title:"ãƒ‡ãƒãƒ•",     icon:"âš¡", timer:null, judge:null,              fail:null},
  {id:15, type:"missionA",title:"ãƒã‚¹15",     icon:"âœ…", timer:2,    judge:"ã‚®ãƒ–ã‚¢ãƒƒãƒ—ï¼Ÿ",    fail:"back:4"},
  {id:16, type:"missionA",title:"ãƒã‚¹16",     icon:"âœ…", timer:2,    judge:"ã‚®ãƒ–ã‚¢ãƒƒãƒ—ï¼Ÿ",    fail:"back:4"},
  {id:17, type:"choice",  title:"ã‚³ãƒ¼ã‚¹é¸æŠ", icon:"ğŸ¯", timer:null, judge:null,              fail:null},
];

// BASE_SQUARES ç”¨ãƒ†ã‚­ã‚¹ãƒˆ
const SQUARE_TEXTS = {
  0: {desc:"â€»ã”è¤’ç¾ã¾ãŸã¯ç½°ã‚²ãƒ¼ãƒ ã‚’äº‹å‰ã«æ±ºã‚ã¦ãŠãï¼", penalty:null},
  1: {desc:"èƒŒä¸­ã«ãƒ‘ã‚¦ãƒ€ãƒ¼ã‚’ãµã‚Šã‹ã‘ã€ãƒ•ã‚§ã‚¶ãƒ¼ã‚¿ãƒƒãƒã§ï¼‘åˆ†é–“ãã™ãã‚‰ã‚Œã‚‹", penalty:"å£°ã‚’å‡ºã—ã¦ã—ã¾ã£ãŸå ´åˆã¯ã‚¹ã‚¿ãƒ¼ãƒˆã«æˆ»ã‚‹"},
  2: {desc:"ä¸¡æ‰‹ã‚’é ­ã®ä¸Šã«ä¹—ã›ãŸçŠ¶æ…‹ã§è…‹ã‚’ï¼‘åˆ†é–“ãã™ãã‚‰ã‚Œã‚‹", penalty:"è€ãˆã‚‰ã‚Œãšã«æ‰‹ã‚’ä¸‹ã‚ã—ã¦ã—ã¾ã£ãŸå ´åˆã¯ã‚¹ã‚¿ãƒ¼ãƒˆã«æˆ»ã‚‹"},
  3: {desc:"è¶³ã®æŒ‡ã‚’ä¸€æœ¬ä¸€æœ¬é †ç•ªã«ãƒãƒƒã‚µãƒ¼ã‚¸ã•ã‚Œã‚‹", penalty:"å£°ã‚’å‡ºã—ã¦ã—ã¾ã£ãŸå ´åˆã¯ãŠä»•ç½®ãã¨ã—ã¦è¶³ã®è£ã‚’30ç§’ãã™ãã‚‰ã‚ŒãŸå¾Œã«æœ€åˆã®æŒ‡ã‹ã‚‰ã‚„ã‚Šç›´ã™"},
  4: {desc:"å››ã¤ã‚“é€™ã„ã«ãªã‚Šã€ãŠå°»ã‚’é«˜ãçªãä¸Šã’ãŸçŠ¶æ…‹ã§ï¼‘åˆ†é–“ãã™ãã‚‰ã‚Œã‚‹", penalty:"å››ã¤ã‚“é€™ã„ã‚’å´©ã—ãŸå ´åˆã¯æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™ï¼ˆ1åˆ†ã‚¿ã‚¤ãƒãƒ¼å†èµ·å‹•ï¼‰"},
  5: {desc:"ã“ã®å…ˆã®ãƒã‚¹ã«ã¦ã€ã‚»ãƒ©ãƒ”ã‚¹ãƒˆæ¨©é™ã§2å›ã¾ã§æ–½è¡“æ™‚é–“ã‚’ï¼’å€ã«ã§ãã‚‹", penalty:null},
  6: {desc:"ã‚µãƒ†ãƒ³ã‚°ãƒ­ãƒ¼ãƒ–ã§å¤ªã‚‚ã‚‚ã‚’ï¼‘åˆ†é–“ãã™ãã‚‰ã‚Œã‚‹", penalty:null},
  7: {desc:"æŒ‡ç­†ã§è„‡è…¹ã‚’ãªãã‚‹ã‚ˆã†ã«ï¼‘åˆ†é–“ãã™ãã‚‰ã‚Œã‚‹", penalty:null},
  8: {desc:"è¶³ã‚’é–‹ã„ãŸçŠ¶æ…‹ã§ä»°å‘ã‘ã«ãªã‚Šã€é¼ å¾„éƒ¨ã‚’ï¼‘åˆ†é–“ãã™ãã‚‰ã‚Œã‚‹", penalty:"è€ãˆã‚‰ã‚Œãšè¶³ã‚’é–‰ã˜ã¦ã—ã¾ã£ãŸå ´åˆã¯ï¼“ãƒã‚¹æˆ»ã‚‹"},
  9: {desc:"ä»°å‘ã‘ã§ãƒãƒ³ã‚¶ã‚¤ã—ã€ä¸ŠåŠèº«ã‚’ã‚»ãƒ©ãƒ”ã‚¹ãƒˆã®å¥½ããªã‚ˆã†ã«ï¼’åˆ†é–“ãã™ãã‚‰ã‚Œã‚‹", penalty:"è€ãˆã‚‰ã‚Œãšæ‰‹ã‚’ä¸‹ã‚ã—ã¦ã—ã¾ã£ãŸå ´åˆã¯ï¼’ãƒã‚¹æˆ»ã‚‹"},
  10: {desc:"ã†ã¤ä¼ã›ã§æ°—ã‚’ã¤ã‘ã®çŠ¶æ…‹ã§é¦¬ä¹—ã‚Šã«ãªã‚Šã€èƒŒä¸­ã¨ãŠã—ã‚Šã‚’ï¼’åˆ†é–“ãã™ãã‚‰ã‚Œã‚‹", penalty:null},
  11: {desc:"ä»°å‘ã‘ã§å¤§ã®å­—ã®ä½“å‹¢ã«ãªã‚Šã€å…¨èº«ã‚’ï¼’åˆ†é–“ãã™ãã‚‰ã‚Œã‚‹", penalty:"å¤§ã®å­—ã‚’å´©ã—ã¦ã—ã¾ã£ãŸå ´åˆã¯+20ç§’ãƒœã‚¿ãƒ³ã§æ™‚é–“ã‚’è¿½åŠ "},
  12: {desc:"ç«‹ã£ãŸã¾ã¾ä¸¡æ‰‹ã‚’é ­ã®ä¸Šã«ä¹—ã›ã€ä¸‹åŠèº«ã‚’ï¼’åˆ†é–“ãã™ãã‚‰ã‚Œã‚‹", penalty:"å´©ã‚Œè½ã¡ã¦ã—ã¾ã£ãŸå ´åˆã¯æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™ï¼ˆ2åˆ†ã‚¿ã‚¤ãƒãƒ¼å†èµ·å‹•ï¼‰"},
  13: {desc:"å››ã¤ã‚“é€™ã„ã§å…¨èº«ã‚’ï¼’åˆ†é–“ãã™ãã‚‰ã‚Œã‚‹", penalty:"è€ãˆã‚‰ã‚Œãšä½“å‹¢ã‚’å´©ã—ã¦ã—ã¾ã£ãŸå ´åˆã¯ï¼”ãƒã‚¹æˆ»ã‚‹"},
  14: {desc:"ã“ã®å…ˆå…¨ã¦ã®æ–½è¡“æ™‚é–“ãŒ1.5å€ã«ãªã‚‹", penalty:null},
  15: {desc:"å¾Œã‚å‘ãã§é¦¬ä¹—ã‚Šã«ãªã‚Šã€è‚¡é–“å‘¨ã‚Šã«ã‚ªã‚¤ãƒ«ã‚’å¡—ã£ã¦ï¼’åˆ†é–“ãã™ãã‚‰ã‚Œã‚‹", penalty:"ã‚®ãƒ–ã‚¢ãƒƒãƒ—ã—ãŸå ´åˆã¯ï¼”ãƒã‚¹æˆ»ã‚‹"},
  16: {desc:"æ°—ã‚’ã¤ã‘ã®çŠ¶æ…‹ã§é¦¬ä¹—ã‚Šã«ãªã‚Šã€é¦–ã¨è€³ã‚’ï¼’åˆ†é–“ãã™ãã‚‰ã‚Œã‚‹", penalty:"ã‚®ãƒ–ã‚¢ãƒƒãƒ—ã—ãŸå ´åˆã¯ï¼”ãƒã‚¹æˆ»ã‚‹"},
  17: {desc:"ã€Œæ‹·å•ã‚³ãƒ¼ã‚¹ã€ã€Œç”˜ã€…ã‚³ãƒ¼ã‚¹ã€ã€Œãƒãƒ‹ã‚¢ãƒƒã‚¯ã‚³ãƒ¼ã‚¹ã€ã‚’ãŠé¸ã³ãã ã•ã„ã€‚ä»¥å¾Œã™ã¹ã¦ã®ãƒã‚¹ã‚’é€šéã—ã¾ã™ã€‚æ–½è¡“æ™‚é–“ã¯ã•ã„ã“ã‚ã®ç›®Ã—ï¼‘åˆ†ã§ã™ã€‚", penalty:null},
};
const COURSE_SQUARES = {
  sweet:[
    {id:18,type:"missionB",title:"ç”˜ã€…1",      icon:"ğŸ’•",timer:"dice"},
    {id:19,type:"missionB",title:"ç”˜ã€…2",      icon:"ğŸ’•",timer:"dice"},
    {id:20,type:"missionB",title:"ç”˜ã€…3",      icon:"ğŸ’•",timer:"dice"},
  ],
  torture:[
    {id:18,type:"missionB",title:"æ‹·å•1",      icon:"â›“ï¸",timer:"dice"},
    {id:19,type:"missionB",title:"æ‹·å•2",      icon:"â›“ï¸",timer:"dice"},
    {id:20,type:"missionB",title:"æ‹·å•3",      icon:"â›“ï¸",timer:"dice"},
  ],
  maniac:[
    {id:18,type:"missionB",title:"ãƒãƒ‹ã‚¢ãƒƒã‚¯1",icon:"ğŸ”¥",timer:"dice"},
    {id:19,type:"missionB",title:"ãƒãƒ‹ã‚¢ãƒƒã‚¯2",icon:"ğŸ”¥",timer:"dice"},
    {id:20,type:"missionB",title:"ãƒãƒ‹ã‚¢ãƒƒã‚¯3",icon:"ğŸ”¥",timer:"dice"},
  ],
};

// COURSE_SQUARES ç”¨ãƒ†ã‚­ã‚¹ãƒˆ
const COURSE_SQUARE_TEXTS = {
  sweet:{
    18: {desc:"ãƒãƒƒã‚¯ãƒã‚°ã§çµ¡ã¿ã¤ãé¦–ã‚’ãã™ãã‚‰ã‚Œã‚‹", penalty:null},
    19: {desc:"æ­£é¢ã‹ã‚‰ãƒã‚°ã§æ‹˜æŸã—ãŸã¾ã¾èƒŒä¸­ã‚„è„‡è…¹ã‚’ãã™ãã‚‰ã‚Œã‚‹", penalty:null},
    20: {desc:"æ·»ã„å¯ã®å¯†ç€æ‹˜æŸã§å…¨èº«ã‚’ãã™ãã‚‰ã‚Œã‚‹", penalty:null},
  },
  torture:{
    18: {desc:"ã†ã¤ä¼ã›ã§å¤§ã®å­—ã«æ‹˜æŸã•ã‚Œãã™ãã‚Šæ‹·å•ã‚’å—ã‘ã‚‹", penalty:null},
    19: {desc:"ä»°å‘ã‘ã§å¤§ã®å­—ã«æ‹˜æŸã•ã‚Œãã™ãã‚Šæ‹·å•ã‚’å—ã‘ã‚‹", penalty:null},
    20: {desc:"ä»°å‘ã‘ã§å¤§ã®å­—ã«æ‹˜æŸã•ã‚Œé›»ãƒÃ—ãã™ãã‚Šã®äº¤äº’æ‹·å•ã‚’å—ã‘ã‚‹", penalty:null},
  },
  maniac:{
    18: {desc:"ã‚ªã‚¤ãƒ«Ã—ãƒ˜ãƒƒãƒ‰ãƒãƒƒã‚µãƒ¼ã‚¸ãƒ£ãƒ¼ã§å…¨èº«ã‚’ãã™ãã‚‰ã‚Œã‚‹", penalty:null},
    19: {desc:"ä¸¡æ‰‹ã‚’æ‹˜æŸã•ã‚Œé›»æ°—ã‚ã‚“ã¾ã‚’å—ã‘ã‚‹ã€€å¾ŒåŠã¯åŒæ™‚ã«è¶³ã®è£ã‚’ãã™ãã‚‰ã‚Œã‚‹", penalty:null},
    20: {desc:"ãƒ†ãƒ¼ãƒ—ã§å››ã¤ã‚“é€™ã„ã«æ‹˜æŸã•ã‚Œã€è‚¡é–“å‘¨ã‚Šã«ã‚ªã‚¤ãƒ«ã‚’ãŸã£ã·ã‚Šå¡—ã£ã¦ãã™ãã‚‰ã‚Œã‚‹", penalty:null},
  },
};

const GOAL_SQ = {id:21,type:"goal",title:"ã‚´ãƒ¼ãƒ«ï¼",icon:"ğŸ†",timer:null};
const MINIMAP_ROWS = [[0,1,2,3,4],[8,7,6,5],[9,10,11,12],[16,15,14,13],[17],[18,19,20,21]];
const COL = {
  start:   {bg:"#4ade80",border:"#16a34a",text:"#052e16"},
  debuff1: {bg:"#fb923c",border:"#c2410c",text:"#431407"},
  debuff2: {bg:"#fb923c",border:"#c2410c",text:"#431407"},
  missionA:{bg:"#f472b6",border:"#be185d",text:"#500724"},
  missionB:{bg:"#818cf8",border:"#4338ca",text:"#1e1b4b"},
  choice:  {bg:"#facc15",border:"#a16207",text:"#422006"},
  goal:    {bg:"#34d399",border:"#059669",text:"#022c22"},
};
const TYPE_LABEL = {
  start:"ã‚¹ã‚¿ãƒ¼ãƒˆ", debuff1:"ãƒ‡ãƒãƒ•", debuff2:"ãƒ‡ãƒãƒ•",
  missionA:"åˆ¤å®šãƒŸãƒƒã‚·ãƒ§ãƒ³", missionB:"ã‚ªãƒ¼ãƒˆãƒŸãƒƒã‚·ãƒ§ãƒ³",
  choice:"ã‚³ãƒ¼ã‚¹é¸æŠ", goal:"ã‚´ãƒ¼ãƒ«",
};

// ============================================================
// ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
// ============================================================
function getSquareText(id) {
  // BASE_SQUARES ç”¨
  if(id <= 17) return SQUARE_TEXTS[id] || {desc:"", penalty:null};
  // COURSE_SQUARES ç”¨
  if(id >= 18 && id <= 20 && G.course) {
    const courseTexts = COURSE_SQUARE_TEXTS[G.course] || {};
    return courseTexts[id] || {desc:"", penalty:null};
  }
  return {desc:"", penalty:null};
}

// ============================================================
// çŠ¶æ…‹
// ============================================================
let G = initState();
function initState(){
  return {
    pos:0, course:null,
    timerSec:0, timerInit:0, timerRunning:false, timerIv:null,
    doubleCount:0, multiplier:1.0, mas3:0, doubleUsed:false, timerOriginal:0,
    revealed:new Set([0]),
    phase:"roll", diceValue:null,
  };
}

// ============================================================
// Audio
// ============================================================
let audioCtx=null;
function getCtx(){
  if(!audioCtx) audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  return audioCtx;
}
function note(f,d,t="sine",v=0.28){
  try{
    const c=getCtx(),o=c.createOscillator(),g=c.createGain();
    o.connect(g);g.connect(c.destination);
    o.frequency.value=f;o.type=t;
    g.gain.setValueAtTime(v,c.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001,c.currentTime+d);
    o.start(c.currentTime);o.stop(c.currentTime+d);
  }catch(_){}
}
const AU = {
  unlock:()=>{try{const c=getCtx();if(c.state==="suspended")c.resume();const b=c.createBuffer(1,1,22050),s=c.createBufferSource();s.buffer=b;s.connect(c.destination);s.start(0);}catch(_){}},
  dice:  ()=>note(300,0.06,"square",0.12),
  move:  ()=>{note(660,0.1);setTimeout(()=>note(880,0.1),120);},
  debuff:()=>{note(220,0.3,"sawtooth",0.18);setTimeout(()=>note(160,0.3,"sawtooth",0.18),320);},
  mission:()=>[523,659,784].forEach((f,i)=>setTimeout(()=>note(f,0.2),i*100)),
  end:   ()=>[880,1046,1318].forEach((f,i)=>setTimeout(()=>note(f,0.3),i*150)),
  tick:  ()=>note(1200,0.03,"square",0.06),
  fanfare:()=>[[523,0],[659,200],[784,400],[1046,600],[784,750],[1046,900]].forEach(([f,t])=>setTimeout(()=>note(f,0.3),t)),
};

// ============================================================
// ãƒŸãƒ‹ãƒãƒƒãƒ—æç”»
// ============================================================
function buildMinimap(){
  const mm=document.getElementById("minimap");
  mm.innerHTML="";
  function getSq(id){
    if(id<=17) return BASE_SQUARES.find(s=>s.id===id);
    if(id>=18&&id<=20&&G.course) return (COURSE_SQUARES[G.course]||[])[id-18];
    if(id===21) return GOAL_SQ;
    return null;
  }
  MINIMAP_ROWS.forEach(row=>{
    const rowEl=document.createElement("div");
    rowEl.className="minimap-row";
    row.forEach(id=>{
      const sq=getSq(id);
      if(!sq){rowEl.appendChild(document.createElement("div"));return;}
      const rev=G.revealed.has(id), active=id===G.pos;
      // ã‚´ãƒ¼ãƒ«(id===21)ã¯ã‚³ãƒ¼ã‚¹é¸æŠå¾Œã¯å¸¸ã«è¡¨ç¤º
      const showGoal = id===21 && G.course;
      const c=COL[sq.type]||COL.missionA;
      const el=document.createElement("div");
      el.className="minimap-sq"+(rev||active||showGoal?" rev":"")+(active?" active":"");
      el.style.background = active?c.bg : rev?c.bg+"55" : showGoal?c.bg+"44" : "#1e1b4b";
      el.style.borderColor = active?c.border : rev?c.border+"66" : showGoal?c.border+"55" : "#3730a3";
      el.style.color = active?c.text : rev?c.text+"aa" : showGoal?c.text+"99" : "#4338ca";
      if(active){
        el.style.boxShadow=`0 0 14px ${c.bg}cc,0 0 28px ${c.bg}55`;
        const deer=document.createElement("img");
        deer.src=DEER_B64;
        deer.style.cssText="position:absolute;top:-14px;left:50%;transform:translateX(-50%);width:22px;height:22px;object-fit:contain;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.6));";
        el.appendChild(deer);
      }
      el.appendChild(document.createTextNode(rev||active||showGoal?sq.icon:"ï¼Ÿ"));
      rowEl.appendChild(el);
    });
    mm.appendChild(rowEl);
  });
}

// ============================================================
// ãƒã‚¹æƒ…å ±è¡¨ç¤º
// ============================================================
function updateSqInfo(){
  const sq=getCurrentSq();
  if(!sq) return;
  const sqText=getSquareText(sq.id);
  const c=COL[sq.type]||COL.missionA;
  const box=document.getElementById("sqInfo");
  box.style.background=`linear-gradient(135deg,${c.bg}22,${c.bg}08)`;
  box.style.borderColor=c.border+"66";
  document.getElementById("sqIcon").textContent=sq.icon;
  document.getElementById("sqTitle").textContent=sq.title;
  document.getElementById("sqType").textContent=TYPE_LABEL[sq.type]||"";
  document.getElementById("sqDesc").textContent=sqText.desc;
  const pe=document.getElementById("sqPenalty");
  if(sqText.penalty){pe.textContent="âš ï¸ "+sqText.penalty;pe.style.display="";}
  else pe.style.display="none";
  document.getElementById("posLabel").textContent=`ç¾åœ¨ä½ç½®ï¼šãƒã‚¹${G.pos}`;
}

// ============================================================
// ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤º
// ============================================================
function updateTimerDisplay(){
  const min=Math.floor(G.timerSec/60), s=G.timerSec%60;
  const str=`${String(min).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
  const el=document.getElementById("timerDisp");
  el.textContent=str;
  el.className="timer-display"+(G.timerRunning?" running":"")+(G.timerSec>0&&G.timerSec<=10?" danger":"");
  // ã‚¿ã‚°
  const tags=document.getElementById("timerTags");
  tags.innerHTML="";
  if(G.multiplier!==1.0){
    const t=document.createElement("span");
    t.className="timer-tag";
    t.style.cssText="background:#fb923c22;border-color:#fb923c99;color:#fb923c;";
    t.textContent=`âš¡ Ã—${G.multiplier.toFixed(1)}å€`;
    tags.appendChild(t);
  }
  if(G.doubleCount>0){
    const t=document.createElement("span");
    t.className="timer-tag";
    t.style.cssText="background:#facc1522;border-color:#facc1599;color:#facc15;";
    t.textContent=`ğŸ« 2å€åˆ¸Ã—${G.doubleCount}`;
    tags.appendChild(t);
  }
  // 2å€ãƒœã‚¿ãƒ³
  const doubleBtn = document.getElementById("timerDoubleBtn");
  doubleBtn.style.display=G.doubleCount>0?"":"none";
  doubleBtn.disabled = G.timerRunning || G.doubleUsed; // å‹•ä½œä¸­ã¯ç„¡åŠ¹åŒ–
  document.getElementById("timerAdd20Btn").style.display=G.pos===11?"":"none";
  // ã‚¹ã‚¿ãƒ¼ãƒˆ/ä¸€æ™‚åœæ­¢åˆ‡ã‚Šæ›¿ãˆ
  const sb=document.getElementById("timerStartBtn");
  if(G.timerRunning){sb.textContent="â¸ ä¸€æ™‚åœæ­¢";sb.className="btn btn-orange";}
  else{sb.textContent="â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ";sb.className="btn btn-green";}
}

// ============================================================
// ãƒ•ã‚§ãƒ¼ã‚ºåˆ¶å¾¡
// ============================================================
const PHASES=["phaseRoll","phaseSquare","phaseTimer","phaseJudge","phaseCourse","phaseRoulette","phaseGoal"];
function showPhase(name){
  PHASES.forEach(p=>{
    const el=document.getElementById(p);
    if(el) el.style.display= p===name ? "" : "none";
  });
  // ã‚³ãƒ¼ã‚¹é¸æŠå¾Œã¯ã‚µã‚¤ã‚³ãƒ­â†’1ãƒã‚¹é€²ã‚€ãƒœã‚¿ãƒ³ã«åˆ‡ã‚Šæ›¿ãˆ
  if(name==="phaseRoll"){
    const inCourse = G.course && G.pos>=17;
    document.getElementById("diceArea").style.display = inCourse ? "none" : "";
    document.getElementById("advanceArea").style.display = inCourse ? "" : "none";
    
    // ãƒœã‚¿ãƒ³ãƒ©ãƒ™ãƒ«å¤‰æ›´
    if(inCourse){
      const btn = document.getElementById("advanceBtn");
      if(G.pos===17){
        // ã‚³ãƒ¼ã‚¹é¸æŠç›´å¾Œ
        const names = {sweet:"ç”˜ã€…", torture:"æ‹·å•", maniac:"ãƒãƒ‹ã‚¢ãƒƒã‚¯"};
        btn.textContent = `â–¶ ${names[G.course]}ã‚³ãƒ¼ã‚¹ã¸ã™ã™ã‚€`;
      } else {
        // ã‚³ãƒ¼ã‚¹ä¸­
        btn.textContent = "â–¶ 1ãƒã‚¹é€²ã‚€";
      }
    }
  }
}

// ============================================================
// ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯
// ============================================================
function getAllSq(){
  return G.course
    ? [...BASE_SQUARES,...(COURSE_SQUARES[G.course]||[]),GOAL_SQ]
    : BASE_SQUARES;
}
function getCurrentSq(){
  return getAllSq().find(s=>s.id===G.pos)||BASE_SQUARES[0];
}

function resetGame(){
  clearInterval(G.timerIv);
  G=initState();
  document.getElementById("diceResult").textContent="";
  document.getElementById("audioBtn").style.display="";
  buildMinimap();
  updateSqInfo();
  showPhase("phaseRoll");
}

// ã‚µã‚¤ã‚³ãƒ­
const FACES=["âš€","âš","âš‚","âšƒ","âš„","âš…"];
let diceRolling=false;
document.getElementById("diceBtn").addEventListener("click",()=>{
  if(diceRolling) return;
  diceRolling=true;
  AU.dice();
  const btn=document.getElementById("diceBtn");
  btn.classList.add("rolling");
  let n=0;
  const iv=setInterval(()=>{
    btn.textContent=FACES[Math.floor(Math.random()*6)];
    n++;
    if(n>20){
      clearInterval(iv);
      const r=Math.floor(Math.random()*6)+1;
      btn.textContent=FACES[r-1];
      btn.classList.remove("rolling");
      diceRolling=false;
      G.diceValue=r;

      // é€šå¸¸ç§»å‹•ï¼š1ãƒã‚¹ãšã¤ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      setTimeout(()=>{
        const maxId=G.course?21:17;
        const target=Math.min(G.pos+r,maxId);
        const start=G.pos;
        let current=start;
        
        const moveStep=()=>{
          if(current>=target){
            // æœ€çµ‚åœ°ç‚¹ã«åˆ°ç€
            G.revealed.add(target);
            buildMinimap();
            updateSqInfo();
            setTimeout(()=>processCurrentSq(), 600);
            return;
          }
          current++;
          G.pos=current;
          AU.move();
          buildMinimap();
          updateSqInfo();
          setTimeout(moveStep, 400); // 1ãƒã‚¹ã‚ãŸã‚Š400ms
        };
        
        moveStep();
      },1200);
    }
  },70);
});

// ã€Œ1ãƒã‚¹é€²ã‚€ã€ãƒœã‚¿ãƒ³ï¼ˆã‚³ãƒ¼ã‚¹å¾Œï¼‰
document.getElementById("advanceBtn").addEventListener("click",()=>{
  if(G.pos>=21) return;
  G.pos=Math.min(G.pos+1, 21);
  G.revealed.add(G.pos);
  AU.move();
  buildMinimap();
  updateSqInfo();
  setTimeout(()=>processCurrentSq(), 600);
});

// ãƒã‚¹ç¢ºèªï¼ˆç›´æ¥å‘¼ã°ã‚Œã‚‹é–¢æ•°ã«å¤‰æ›´ï¼‰
function processCurrentSq(){
  const sq=getCurrentSq();
  if(sq.type==="goal"){AU.fanfare();showPhase("phaseGoal");return;}
  // ã‚¹ã‚¿ãƒ¼ãƒˆãƒã‚¹ or é¸æŠãƒã‚¹ã¯å³ã‚µã‚¤ã‚³ãƒ­ã¸ï¼ˆåˆ¤å®šãªã—ï¼‰
  if(sq.type==="start"||sq.type==="choice"){
    if(sq.type==="choice") showPhase("phaseCourse");
    else showPhase("phaseRoll");
    return;
  }

  // ãƒ‡ãƒãƒ•å‡¦ç†
  if(sq.type==="debuff1"){
    AU.debuff();
    G.doubleCount+=2; // 2å€åˆ¸Ã—2æšä»˜ä¸ï¼ˆæ¯å›ï¼‰
    G.revealed.add(G.pos); // ãƒ‡ãƒãƒ•ãƒã‚¹ã‚‚å…¬é–‹
    buildMinimap();
    updateTimerDisplay();
    showPhase("phaseRoll");
    return;
  }
  if(sq.type==="debuff2"){
    AU.debuff();
    if(G.multiplier===1.0){
      G.multiplier=1.5; // ä»¥é™ã‚¿ã‚¤ãƒãƒ¼1.5å€ï¼ˆåˆå›ã®ã¿ï¼‰
    }
    G.revealed.add(G.pos); // ãƒ‡ãƒãƒ•ãƒã‚¹ã‚‚å…¬é–‹
    buildMinimap();
    updateTimerDisplay();
    showPhase("phaseRoll");
    return;
  }

  if(sq.type==="choice"){showPhase("phaseCourse");return;}

  if(sq.type==="missionA"||sq.type==="missionB"){
    AU.mission();

    // ã‚³ãƒ¼ã‚¹å¾Œã¯ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã§æ™‚é–“æ±ºå®š
    if(sq.timer==="dice"){
      document.getElementById("rouletteNum").textContent="---";
      document.getElementById("rouletteNum").style.color="#475569";
      document.getElementById("rouletteSpinBtn").disabled=false;
      document.getElementById("rouletteApplyBtn").style.display="none";
      showPhase("phaseRoulette");
      return;
    }

    // timerãŒnullã®ãƒã‚¹ï¼ˆãƒã‚¹3ï¼šã‚¿ã‚¤ãƒãƒ¼ãªã—ã§åˆ¤å®šã®ã¿ï¼‰
    if(sq.timer===null){
      showPhase("phaseJudge");
      return;
    }

    const total=Math.round((sq.timer||1)*60*G.multiplier);
    G.timerSec=total; G.timerInit=total;
    updateTimerDisplay();
    showPhase("phaseTimer");
  }
}

// ã‚¿ã‚¤ãƒãƒ¼// ã‚¿ã‚¤ãƒãƒ¼
function startTimer(){
  if(G.timerRunning) return;
  G.timerRunning=true;
  G.timerIv=setInterval(()=>{
    if(!G.timerRunning){clearInterval(G.timerIv);return;}
    if(G.timerSec<=1){
      clearInterval(G.timerIv);
      G.timerSec=0; G.timerRunning=false;
      updateTimerDisplay();
      AU.end();
      const sq=getCurrentSq();
      if(sq.judge){
        // åˆ¤å®šãƒ©ãƒ™ãƒ«ã‚’å‹•çš„ã«è¨­å®š
        document.getElementById("judgeClearBtn").textContent="â­• ã‚»ãƒ¼ãƒ•";
        document.getElementById("judgeFailBtn").textContent="âœ• ã‚¢ã‚¦ãƒˆ";
        document.getElementById("judgeQuestion").textContent=sq.judge;
        showPhase("phaseJudge");
      } else {
        G.doubleUsed=false;
        showPhase("phaseRoll");
      }
      return;
    }
    G.timerSec--;
    AU.tick();
    updateTimerDisplay();
  },1000);
  updateTimerDisplay();
}
function pauseTimer(){
  G.timerRunning=false;
  clearInterval(G.timerIv);
  updateTimerDisplay();
}

document.getElementById("timerStartBtn").addEventListener("click",()=>{
  if(G.timerRunning) pauseTimer(); else startTimer();
});
document.getElementById("timerResetBtn").addEventListener("click",()=>{
  pauseTimer(); 
  if(G.timerOriginal>0){
    // 2å€ä½¿ç”¨å¾Œã®ãƒªã‚»ãƒƒãƒˆã¯å…ƒã®å€¤ã«æˆ»ã™
    G.timerInit=G.timerOriginal; G.timerSec=G.timerOriginal;
    G.timerOriginal=0; G.doubleCount++; // 2å€åˆ¸ã‚‚æˆ»ã™
  } else {
    G.timerSec=G.timerInit;
  }
  G.doubleUsed=false; 
  updateTimerDisplay();
});
document.getElementById("timerAdd20Btn").addEventListener("click",()=>{
  G.timerSec+=20; updateTimerDisplay();
});
document.getElementById("timerDoubleBtn").addEventListener("click",()=>{
  if(G.doubleCount<=0||G.doubleUsed) return;
  G.timerOriginal=G.timerInit; // å…ƒã®å€¤ã‚’ä¿å­˜
  G.timerSec*=2; G.timerInit*=2; G.doubleCount--; G.doubleUsed=true;
  updateTimerDisplay();
});
document.getElementById("timerSkipBtn").addEventListener("click",()=>{
  document.getElementById("modalSkip").style.display="";
});

// ã‚¹ã‚­ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«
document.getElementById("skipYes").addEventListener("click",()=>{
  document.getElementById("modalSkip").style.display="none";
  pauseTimer(); G.timerSec=0; updateTimerDisplay();
  const sq=getCurrentSq();
  if(sq.judge){
    document.getElementById("judgeClearBtn").textContent="â­• ã‚»ãƒ¼ãƒ•";
    document.getElementById("judgeFailBtn").textContent="âœ• ã‚¢ã‚¦ãƒˆ";
    document.getElementById("judgeQuestion").textContent=sq.judge;
    showPhase("phaseJudge");
  } else {
    G.doubleUsed=false; showPhase("phaseRoll");
  }
});
document.getElementById("skipNo").addEventListener("click",()=>{
  document.getElementById("modalSkip").style.display="none";
});

// åˆ¤å®š
document.getElementById("judgeClearBtn").addEventListener("click",()=>{
  G.doubleUsed=false; showPhase("phaseRoll");
});
document.getElementById("judgeFailBtn").addEventListener("click",()=>{
  applyFail();
});
function applyFail(){
  const sq=getCurrentSq();
  const fail=sq?.fail;
  G.doubleUsed=false;

  if(fail==="restart"){
    G.pos=0;
    buildMinimap(); updateSqInfo();
    // æˆ»ã£ãŸå…ˆã®ãƒã‚¹ã‚’å³å®Ÿè¡Œ
    processCurrentSq();
  } else if(fail==="retry"){
    const total=Math.round((sq.timer||1)*60*G.multiplier);
    G.timerSec=total; G.timerInit=total;
    updateTimerDisplay(); showPhase("phaseTimer");
  } else if(fail&&fail.startsWith("back:")){
    const n=parseInt(fail.split(":")[1]);
    G.pos=Math.max(0,G.pos-n);
    buildMinimap(); updateSqInfo();
    // æˆ»ã£ãŸå…ˆã®ãƒã‚¹ã‚’å³å®Ÿè¡Œ
    processCurrentSq();
  } else if(fail&&fail.startsWith("penalty:")){
    const sec=parseInt(fail.split(":")[1]);
    G.timerSec=sec; G.timerInit=sec;
    updateTimerDisplay(); showPhase("phaseTimer");
  } else if(fail&&fail.startsWith("add:")){
    const sec=parseInt(fail.split(":")[1]);
    G.timerSec+=sec; G.timerInit+=sec;
    updateTimerDisplay(); showPhase("phaseTimer");
  } else {
    buildMinimap(); updateSqInfo(); showPhase("phaseRoll");
  }
}

// ã‚³ãƒ¼ã‚¹é¸æŠ
function selectCourse(id){
  G.course=id;
  G.pos=17; // ã‚³ãƒ¼ã‚¹é¸æŠãƒã‚¹ã«ç•™ã¾ã‚‹ï¼ˆæ¬¡ã®ã‚µã‚¤ã‚³ãƒ­ã§18ã¸ï¼‰
  // ã‚³ãƒ¼ã‚¹å¾Œã¯revealedãƒªã‚»ãƒƒãƒˆï¼ˆãƒŸãƒ‹ãƒãƒƒãƒ—ã¯ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®ã¾ã¾ï¼‰
  buildMinimap(); updateSqInfo(); showPhase("phaseRoll");
}
["Sweet","Torture","Maniac"].forEach(name=>{
  document.getElementById(`course${name}Btn`).addEventListener("click",()=>{
    selectCourse(name.toLowerCase());
  });
});
document.getElementById("courseRandomBtn").addEventListener("click",()=>{
  // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã§ã‚³ãƒ¼ã‚¹æ±ºå®š
  const courses=["sweet","torture","maniac"];
  const labels=["ğŸ’• ç”˜ã€…","â›“ï¸ æ‹·å•","ğŸ”¥ ãƒãƒ‹ã‚¢ãƒƒã‚¯"];
  const colors=["#f472b6","#818cf8","#fb923c"];
  let n=0;
  const el=document.createElement("div");
  el.style.cssText="position:fixed;inset:0;background:rgba(0,0,0,0.85);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:2000;";
  const disp=document.createElement("div");
  disp.style.cssText="font-size:48px;font-weight:bold;color:white;margin-bottom:20px;min-width:220px;text-align:center;";
  disp.textContent="ğŸ²";
  el.appendChild(disp);
  document.body.appendChild(el);
  const go=()=>{
    const i=Math.floor(Math.random()*3);
    disp.style.color=colors[i];
    disp.textContent=labels[i];
    n++;
    const d=n<15?80:n<25?150:300;
    if(n<32) setTimeout(go,d);
    else{
      const chosen=Math.floor(Math.random()*3);
      disp.textContent="ğŸ‰ "+labels[chosen]+" ğŸ‰";
      disp.style.color=colors[chosen];
      setTimeout(()=>{ document.body.removeChild(el); selectCourse(courses[chosen]); },1200);
    }
  };
  go();
});


// ã‚¿ã‚¤ãƒ ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ
const TIME_ROULETTE=[1,2,3,4,5,6];
const ZEN={"1":"ï¼‘","2":"ï¼’","3":"ï¼“","4":"ï¼”","5":"ï¼•","6":"ï¼–","7":"ï¼—","8":"ï¼˜","9":"ï¼™","10":"ï¼‘ï¼"};
let rouletteSpinning=false;
document.getElementById("rouletteSpinBtn").addEventListener("click",()=>{
  if(rouletteSpinning) return;
  rouletteSpinning=true;
  const numEl=document.getElementById("rouletteNum");
  // æ±ºå®šãƒœã‚¿ãƒ³ã¯éè¡¨ç¤ºï¼ˆç¢ºå®šã§å³ã‚¿ã‚¤ãƒãƒ¼ã¸ï¼‰
  document.getElementById("rouletteApplyBtn").style.display="none";
  numEl.style.color="#f472b6";
  numEl.style.textShadow="0 0 24px #f472b688";
  document.getElementById("rouletteSpinBtn").disabled=true;
  let n=0;
  const go=()=>{
    const t=TIME_ROULETTE[Math.floor(Math.random()*TIME_ROULETTE.length)];
    numEl.textContent=(ZEN[String(t)]||String(t))+"åˆ†";
    n++;
    const d=n<15?80:n<25?150:260;
    if(n<32) setTimeout(go,d);
    else{
      const r=TIME_ROULETTE[Math.floor(Math.random()*TIME_ROULETTE.length)];
      numEl.textContent=(ZEN[String(r)]||String(r))+"åˆ†";
      numEl.style.color="#4ade80";
      numEl.style.textShadow="0 0 20px #4ade8088";
      rouletteSpinning=false;
      // ç¢ºå®šã§å³ã‚¿ã‚¤ãƒãƒ¼ã¸ï¼ˆãƒ‡ãƒãƒ•é©ç”¨æ¸ˆã¿ï¼‰
      setTimeout(()=>{
        const total=Math.round(r*60*G.multiplier);
        G.timerSec=total; G.timerInit=total;
        updateTimerDisplay(); showPhase("phaseTimer");
      }, 800);
    }
  };
  go();
});
// éŸ³ã‚’ON
document.getElementById("audioBtn").addEventListener("click",()=>{
  AU.unlock();
  document.getElementById("audioBtn").style.display="none";
});

// ã‚´ãƒ¼ãƒ«
document.getElementById("goalReplayBtn").addEventListener("click",resetGame);

// ============================================================
// åˆæœŸåŒ–
// ============================================================
buildMinimap();
updateSqInfo();
showPhase("phaseRoll");
</script>
</body>
</html>